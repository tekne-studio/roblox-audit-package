name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
  workflow_run:
    workflows: ["Auto Release"]
    types:
      - completed

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    # Only run if triggered by tag push, manual dispatch, or successful auto-release
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write  # Required for creating releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags

      - name: Create release archives
        run: |
          mkdir -p dist

          # Since these are pure Lua scripts, they're platform-independent
          # Create platform-specific packages (Rokit requirement)

          # Package structure
          mkdir -p roblox-audit
          cp rokit.toml roblox-audit/
          cp -r src roblox-audit/

          # Create platform-specific archives (Rokit expects these naming conventions)
          # macOS (both Intel and ARM)
          tar -czf dist/roblox-audit-macos-x86_64.tar.gz roblox-audit
          tar -czf dist/roblox-audit-macos-aarch64.tar.gz roblox-audit

          # Linux
          tar -czf dist/roblox-audit-linux-x86_64.tar.gz roblox-audit
          tar -czf dist/roblox-audit-linux-aarch64.tar.gz roblox-audit

          # Windows
          zip -r dist/roblox-audit-windows-x86_64.zip roblox-audit

      - name: Extract version
        id: get_version
        run: |
          # Try to get version from tag first (manual or tag push trigger)
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # Get version from rokit.toml (workflow_run trigger)
            VERSION=$(grep '^version = ' rokit.toml | cut -d'"' -f2)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Roblox Audit Tools v${{ steps.get_version.outputs.VERSION }}

            ### Installation

            ```bash
            rokit add tekne-studio/roblox-audit@${{ steps.get_version.outputs.VERSION }}
            ```

            ### What's included

            - üîç **analyze-dependencies** - Detect circular dependencies
            - üé® **visualize-dependencies** - Generate dependency graphs
            - üõ°Ô∏è **audit** - Comprehensive code quality checks (auto-initializes configs)

            See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for full documentation.
          files: |
            dist/*.tar.gz
            dist/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
