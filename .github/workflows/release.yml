name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
  workflow_run:
    workflows: ["Auto Release"]
    types:
      - completed

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    # Only run if triggered by tag push, manual dispatch, or successful auto-release
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write  # Required for creating releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all tags

      - name: Install darklua
        run: |
          curl -L https://github.com/seaofvoices/darklua/releases/latest/download/darklua-linux-x86_64.zip -o darklua.zip
          unzip darklua.zip
          chmod +x darklua
          sudo mv darklua /usr/local/bin/

      - name: Bundle scripts with darklua
        run: |
          # Create dist directory
          mkdir -p dist
          # Bundle audit.lua with its dependencies
          darklua process --config .darklua.json5 src/audit.lua dist/audit-bundled-temp.lua
          # Add shebang to bundled output
          echo '#!/usr/bin/env lua' > dist/audit-bundled.lua
          cat dist/audit-bundled-temp.lua >> dist/audit-bundled.lua
          chmod +x dist/audit-bundled.lua

      - name: Create release archives
        run: |
          # Package structure - use bundled script
          mkdir -p roblox-audit
          cp rokit.toml roblox-audit/
          cp dist/audit-bundled.lua roblox-audit/audit.lua

          # Create platform-specific archives (Rokit expects these naming conventions)
          # macOS (both Intel and ARM)
          tar -czf dist/roblox-audit-macos-x86_64.tar.gz roblox-audit
          tar -czf dist/roblox-audit-macos-aarch64.tar.gz roblox-audit

          # Linux
          tar -czf dist/roblox-audit-linux-x86_64.tar.gz roblox-audit
          tar -czf dist/roblox-audit-linux-aarch64.tar.gz roblox-audit

          # Windows
          zip -r dist/roblox-audit-windows-x86_64.zip roblox-audit

      - name: Extract version
        id: get_version
        run: |
          # Try to get version from tag first (manual or tag push trigger)
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # Get version from rokit.toml (workflow_run trigger)
            VERSION=$(grep '^version = ' rokit.toml | cut -d'"' -f2)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -v "v$VERSION" | head -1 || echo "")

          # Get the latest commit with full description (subject + body)
          LATEST_COMMIT=$(git log -1 --pretty=format:"%s%n%n%b" --no-merges)

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, showing latest commit"
            {
              echo 'CHANGELOG<<EOF'
              echo "$LATEST_COMMIT"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "Generating changelog from $PREVIOUS_TAG to v$VERSION"
            # Count commits in range
            COMMIT_COUNT=$(git log ${PREVIOUS_TAG}..HEAD --oneline --no-merges | wc -l)

            if [ "$COMMIT_COUNT" -eq 1 ]; then
              # Only one commit - show full description
              {
                echo 'CHANGELOG<<EOF'
                echo "$LATEST_COMMIT"
                echo 'EOF'
              } >> $GITHUB_OUTPUT
            else
              # Multiple commits - show latest with full description, others with just title
              OTHER_COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --skip=1 --pretty=format:"- %s" --no-merges)
              {
                echo 'CHANGELOG<<EOF'
                echo "### Latest Changes"
                echo ""
                echo "$LATEST_COMMIT"
                echo ""
                echo "### Other Changes in This Release"
                echo ""
                echo "$OTHER_COMMITS"
                echo 'EOF'
              } >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Roblox Audit Tools v${{ steps.get_version.outputs.VERSION }}

            ### Installation

            ```bash
            rokit add tekne-studio/roblox-audit@${{ steps.get_version.outputs.VERSION }}
            ```

            ### What's New

            ${{ steps.changelog.outputs.CHANGELOG }}

            ### Features

            Run `roblox-audit` to get:
            - üîç **Circular dependency detection**
            - üé® **Dependency graph visualization** (SVG/PNG)
            - üìù **Type checking** (luau-lsp)
            - üîé **Linting** (Selene)
            - üé® **Style checking** (StyLua)
            - üìÇ **Project structure analysis**
            - üìä **Comprehensive reports**

            ### Documentation

            See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for detailed usage instructions.
          files: |
            dist/*.tar.gz
            dist/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
